# Анализ рисков текущей архитектуры InsureTech

**Документ ID:** TASK3-RISKS-001  
**Дата:** 2026-01-31  
**Версия:** 1.0

---

## 1. Контекст

Сервисы `core-app` и `ins-comp-settlement` получают данные о продуктах через REST API сервиса `ins-product-aggregator`. Текущая архитектура использует синхронное взаимодействие с локальными репликами данных.

**Текущие параметры:**
- Количество страховых компаний: 5
- Планируемое количество: 10
- Частота запросов `core-app` → `ins-product-aggregator`: каждые 15 минут
- Частота запросов `ins-comp-settlement` → `ins-product-aggregator`: 1 раз в сутки (ночью)
- Частота запросов `ins-comp-settlement` → `core-app`: 1 раз в сутки

---

## 2. Выявленные проблемы и риски

### 2.1. Риски синхронного REST-взаимодействия

| ID | Риск | Вероятность | Влияние | Описание |
|----|------|-------------|---------|----------|
| R-01 | Каскадные отказы | Высокая | Критическое | При недоступности `ins-product-aggregator` или одной из страховых компаний запросы от `core-app` и `ins-comp-settlement` блокируются. Увеличение числа страховых компаний до 10 удваивает вероятность отказа. |
| R-02 | Увеличение латентности | Высокая | Высокое | Агрегация данных от 10 страховых компаний в синхронном режиме увеличивает время ответа пропорционально количеству интеграций. При таймауте одной компании весь запрос задерживается. |
| R-03 | Временная связанность (Temporal Coupling) | Высокая | Высокое | Все сервисы должны быть доступны одновременно для успешного выполнения операции. Это создаёт жёсткую зависимость между компонентами. |

### 2.2. Риски локальных реплик данных

| ID | Риск | Вероятность | Влияние | Описание |
|----|------|-------------|---------|----------|
| R-04 | Неконсистентность данных | Средняя | Высокое | `core-app` обновляет данные каждые 15 минут, `ins-comp-settlement` — раз в сутки. В течение дня данные в `ins-comp-settlement` могут устареть, что приведёт к ошибкам в расчётах взаиморасчётов. |
| R-05 | Дублирование логики синхронизации | Средняя | Среднее | Каждый сервис реализует собственную логику обновления локальной реплики. Это увеличивает сложность поддержки и вероятность ошибок. |
| R-06 | Потеря обновлений | Средняя | Высокое | При сбое во время синхронизации обновления могут быть потеряны. Отсутствует механизм гарантированной доставки изменений. |

### 2.3. Риски масштабирования

| ID | Риск | Вероятность | Влияние | Описание |
|----|------|-------------|---------|----------|
| R-07 | Линейный рост нагрузки на `ins-product-aggregator` | Высокая | Высокое | При увеличении числа страховых компаний до 10 нагрузка на агрегатор удваивается. Каждый запрос требует 10 внешних вызовов вместо 5. |
| R-08 | Увеличение времени формирования реестра | Средняя | Среднее | `ins-comp-settlement` при формировании ночного реестра должен получить данные о всех страховках за день. При росте объёма данных время обработки увеличивается. |
| R-09 | Ограниченная пропускная способность | Высокая | Критическое | Синхронный REST не позволяет эффективно обрабатывать пиковые нагрузки. При рекламной кампании система может не справиться с возросшим числом запросов. |

### 2.4. Риски отказоустойчивости

| ID | Риск | Вероятность | Влияние | Описание |
|----|------|-------------|---------|----------|
| R-10 | Отсутствие retry с backoff | Средняя | Высокое | При временных сбоях страховых компаний нет механизма автоматического повтора с экспоненциальной задержкой. |
| R-11 | Отсутствие Circuit Breaker | Средняя | Высокое | Медленная или недоступная страховая компания продолжает получать запросы, что усугубляет проблему и расходует ресурсы. |
| R-12 | Единая точка отказа | Высокая | Критическое | `ins-product-aggregator` является единой точкой отказа для получения данных о продуктах. Его недоступность блокирует работу `core-app` и `ins-comp-settlement`. |

---

## 3. Рекомендации по митигации

### 3.1. Переход на Event-Driven архитектуру

**Решение:** Внедрить Event Broker (Apache Kafka) для асинхронного обмена данными между сервисами.

**Преимущества:**
- Устранение временной связанности между сервисами
- Гарантированная доставка сообщений
- Возможность replay событий при сбоях
- Горизонтальное масштабирование consumer'ов

### 3.2. Применение паттерна Transactional Outbox

**Решение:** Использовать Transactional Outbox для гарантированной публикации событий.

**Обоснование:**
- Атомарность записи в БД и публикации события
- Предотвращение потери событий при сбоях
- Идемпотентность обработки на стороне consumer'ов

**Применение:**
- `ins-product-aggregator`: публикация событий об обновлении продуктов/тарифов
- `core-app`: публикация событий об оформленных страховках

### 3.3. Изменение потоков данных

| Текущий поток | Предлагаемый поток |
|---------------|-------------------|
| `core-app` → REST → `ins-product-aggregator` (каждые 15 мин) | `ins-product-aggregator` → Event → `core-app` (по факту изменения) |
| `ins-comp-settlement` → REST → `ins-product-aggregator` (раз в сутки) | `ins-product-aggregator` → Event → `ins-comp-settlement` (по факту изменения) |
| `ins-comp-settlement` → REST → `core-app` (раз в сутки) | `core-app` → Event → `ins-comp-settlement` (по факту оформления страховки) |

---

## 4. Матрица рисков после митигации

| ID | Риск | Вероятность (до) | Вероятность (после) | Влияние (до) | Влияние (после) |
|----|------|------------------|---------------------|--------------|-----------------|
| R-01 | Каскадные отказы | Высокая | Низкая | Критическое | Низкое |
| R-02 | Увеличение латентности | Высокая | Низкая | Высокое | Низкое |
| R-03 | Временная связанность | Высокая | Низкая | Высокое | Низкое |
| R-04 | Неконсистентность данных | Средняя | Низкая | Высокое | Среднее |
| R-05 | Дублирование логики | Средняя | Низкая | Среднее | Низкое |
| R-06 | Потеря обновлений | Средняя | Низкая | Высокое | Низкое |
| R-07 | Линейный рост нагрузки | Высокая | Средняя | Высокое | Среднее |
| R-12 | Единая точка отказа | Высокая | Средняя | Критическое | Среднее |

---

## 5. Заключение

Текущая архитектура с синхронным REST-взаимодействием и локальными репликами данных создаёт риски при масштабировании до 10 страховых компаний. Переход на Event-Driven архитектуру с использованием Transactional Outbox позволит:

1. Устранить временную связанность между сервисами
2. Обеспечить гарантированную доставку данных
3. Улучшить консистентность локальных реплик
4. Повысить отказоустойчивость системы
