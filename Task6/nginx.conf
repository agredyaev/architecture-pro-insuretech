# Rate limiting zone definition
# Key: client IP address ($binary_remote_addr)
# Zone: partner_limit, 10MB shared memory
# Rate: 10 requests per minute (10r/m)
limit_req_zone $binary_remote_addr zone=partner_limit:10m rate=10r/m;

# Log format for rate-limited requests
log_format rate_limit '$remote_addr - $remote_user [$time_local] '
                      '"$request" $status $body_bytes_sent '
                      '"$http_referer" "$http_user_agent" '
                      'rate_limit_status=$limit_req_status';

server {
    listen 80;
    server_name api.insuretech.local;

    # Access log with rate limit status
    access_log /var/log/nginx/api_access.log rate_limit;
    error_log /var/log/nginx/api_error.log warn;

    # Apply rate limiting to partner API endpoints
    location /api/ {
        # Apply rate limit: 10 requests per minute per IP
        # burst=0 (explicit): no request queuing, immediate rejection
        # nodelay: return 429 immediately when limit exceeded
        limit_req zone=partner_limit burst=0 nodelay;
        
        # Return 429 status code when rate limit exceeded
        limit_req_status 429;
        
        # Log rate-limited requests at warn level
        limit_req_log_level warn;

        proxy_pass http://core-app:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Custom 429 error response with Retry-After header (RFC 6585)
    error_page 429 = @too_many_requests;
    location @too_many_requests {
        default_type application/json;
        add_header Retry-After 60 always;
        return 429 '{"error": "Too Many Requests", "message": "Rate limit exceeded. Maximum 10 requests per minute allowed.", "retry_after": 60}';
    }

    # Health check endpoint (not rate limited)
    location /health {
        return 200 'OK';
        add_header Content-Type text/plain;
    }
}
